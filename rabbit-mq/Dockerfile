ARG OS_VERSION=ltsc2019
FROM mcr.microsoft.com/windows/servercore:$OS_VERSION

ARG RABBIT_VERSION=3.12.10
ENV RABBIT_VERSION=$RABBIT_VERSION
ARG ERLANG_VERSION=26.2.1
ENV ERLANG_VERSION=$ERLANG_VERSION

ENV chocolateyVersion=1.4.0
ENV chocolateyUseWindowsCompression false
ENV ERLANG_SERVICE_MANAGER_PATH="C:\Program Files\Erlang OTP\erts-14.2.1\bin"
ENV RABBITMQ_SERVER="C:\Program Files\RabbitMQ Server\rabbitmq_server-${RABBIT_VERSION}"
ENV ADMIN_PASSWORD=password1234@1
ENV BASE_PASSWORD=password1234@1
ENV BASE_USERNAME=baseuser

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]
RUN [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; \
    iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1')); 
RUN choco install -y erlang --version $env:ERLANG_VERSION
RUN choco install -y rabbitmq --version $env:RABBIT_VERSION

COPY provisioning/ C:/
COPY provisioning/ C:/Users/ContainerAdministrator/AppData/Roaming/RabbitMQ/
RUN mkdir C:/RabbitMessageStore

EXPOSE 4369
EXPOSE 5672
EXPOSE 5671
EXPOSE 15672

WORKDIR C:/Program\ Files/RabbitMQ\ Server/rabbitmq_server-${RABBIT_VERSION}/sbin
RUN ./rabbitmq-service.bat stop
RUN ./rabbitmq-service.bat remove
COPY ./startUp.ps1 ./
COPY ./firstStart.ps1 ./firstStart.ps1
CMD ["powershell", "-Command", "./startUp.ps1"]